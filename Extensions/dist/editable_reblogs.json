{"id":"editable_reblogs","script":"//* TITLE Editable Reblogs **//\n//* VERSION 3.1.0 **//\n//* DESCRIPTION Restores ability to edit previous reblogs of a post **//\n//* DEVELOPER new-xkit **//\n//* FRAME false **//\n//* BETA false **//\n\nXKit.extensions.editable_reblogs = new Object({\n\n\trunning: false,\n\tstate: undefined,\n\tpost_types: {\n\t\tPUBLISH: 0,\n\t\tQUEUE: 1,\n\t\tDRAFT: 2,\n\t\tPRIVATE: 3,\n\t\tSCHEDULE: 4\n\t},\n\n\tselected_post_type: \"PUBLISH\",\n\tscheduled_date: \"Next Tuesday, 10am\",\n\tpost_date_metadata: null,\n\tpost_slug_metadata: null,\n\n\trun: function() {\n\t\tthis.running = true;\n\n\t\tXKit.interface.post_window_listener.add(\"editable_reblogs\", this.post_window.bind(this));\n\n\t\tXKit.tools.add_css(\".control-reblog-tree {display: none; } .post-form--header .reblog-title {margin: 10px; color: #444} \"\n\t\t\t+ \".xkit-editable-reblogs-button { float: right; margin-left: 20px; }\"\n\t\t\t+ \".control.right.xkit-editable-reblogs-control { display: block; width: 210px; text-align: right }\", \"editable_reblogs_remove_content_tree\");\n\n\t\t$(\"body\").on(\"click\", \".create_post_button\", this.make_post.bind(this));\n\n\t\t// DOM nodes containing options disappear before a handler can be run\n\t\t$(\"body\").on(\"click\", this.record_post_settings.bind(this));\n\n\t\t$.each({\"#customUrl_input\": \"post_slug_metadata\", \"#postDate_input\": \"post_date_metadata\"},\n\t\t\tfunction(selector, property){\n\t\t\t\t$('body').on(\"keyup\", selector, function() {\n\t\t\t\t\tXKit.extensions.editable_reblogs[property] = $(this).val();\n\t\t\t\t});\n\t\t\t}\n\t\t);\n\t},\n\n\tpost_window: function() {\n\t\tthis.state = \"initial\";\n\n\t\tif (!this.reblog_tree_exists()) {\n\t\t\treturn;\n\t\t}\n\n\t\t//also just let chat, link, and quote posts do what they do\n\t\tvar post_type = XKit.interface.post_window.post_type();\n\t\tif (post_type.chat || post_type.quote) {\n\t\t\treturn;\n\t\t}\n\n\t\t//disable on pages that don't include reblog_key and post_id in the URL\n\t\t//for now until we've refactored more effectively\n\t\tvar location_path = window.location.pathname;\n\t\tvar location_items = location_path.split(\"/\");\n\t\tlocation_items.shift();\n\t\tif (location_items[0] != \"reblog\" && location_items[0] != \"edit\") {\n\t\t\treturn;\n\t\t}\n\n\t\tvar save_button = $('.post-form--save-button [data-js-clickablesave]');\n\n\t\ttry {\n\t\t\t// Prevent Tumblr's event handler from acting on the save button\n\t\t\tsave_button.removeAttr(\"data-js-clickablesave\");\n\t\t\tthis.initialize_selected_post_type();\n\t\t\tthis.scheduled_date = \"Next Tuesday, 10am\";\n\t\t\tthis.load_initial_metadata();\n\t\t\tthis.process_existing_content();\n\t\t\tthis.state = \"success\";\n\t\t} catch(e) {\n\t\t\tconsole.error(e);\n\n\t\t\tsave_button.attr(\"data-js-clickablesave\", \"\");\n\n\t\t\tif (!e.hide_popup) {\n\t\t\t\tvar github_url = XKit.tools.github_issue(\"Editable Reblogs \"+this.state+\" error\",\n\t\t\t\t\t{ state: this.state, \"ER Version\": XKit.installed.get(\"editable_reblogs\").version },\n\t\t\t\te);\n\n\t\t\t\tXKit.window.show('Editable Reblogs Error', 'ERROR: Editable Reblogs failed to proccess some part of your post safely. '+\n\t\t\t\t\t'Therefore, it has been disabled to prevent unintentional side-effects that could potentially corrupt the post. '+\n\t\t\t\t\t(!e.hide_url ? '<br><br><a target=\"_blank\" href=\"'+github_url+'\">You can report this issue on Github by clicking here</a>':''),\n\t\t\t\t\t'error', '<div id=\"xkit-close-message\" class=\"xkit-button\">OK</div>');\n\t\t\t}\n\t\t}\n\t},\n\n\n\tload_initial_metadata: function() {\n\t\t//if this is an edit, we need to load the custom date and slug metadata if there is any\n\t\t//so we can maintain it if they don't change anything\n\t\tthis.state = \"metadata\";\n\t\tthis.post_date_metadata = \"\";\n\t\tthis.post_slug_metadata = \"\";\n\t\tvar location_path = window.location.pathname;\n\t\tvar location_items = location_path.split(\"/\");\n\t\tlocation_items.shift();\n\t\tif (location_items[0] != \"edit\") {\n\t\t\treturn;\n\t\t}\n\n\t\tvar post_fetch_request = {\n\t\t\tid: parseInt(location_items[1]),\n\t\t\tform_key: XKit.interface.form_key(),\n\t\t\tpost_type: false\n\t\t};\n\n\t\tXKit.interface.fetch(post_fetch_request, function(response) {\n\t\t\tthis.post_date_metadata = response.data.post.date;\n\t\t\tthis.post_slug_metadata = response.data.post.slug;\n\t\t\tif (response.data.post.is_private === 1) {\n\t\t\t\tthis.selected_post_type = \"PRIVATE\";\n\t\t\t}\n\t\t}.bind(this));\n\t},\n\n\tprocess_existing_content: function() {\n\t\tvar reblog_tree = $(\".post-form .reblog-list\");\n\n\t\tvar all_quotes = [];\n\t\tvar old_content = '';\n\t\tvar all_quotes_text = '';\n\n\t\tthis.state = \"processing existing content\";\n\t\t// Guard against double evaluation by marking the tree as processed\n\t\tvar processed_class = 'xkit-editable-reblogs-done';\n\t\tif (reblog_tree.length > 0) {\n\t\t\tthis.state = \"tree processing\";\n\n\t\t\tif (reblog_tree.hasClass(processed_class)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treblog_tree.addClass(processed_class);\n\n\t\t\tthis.state = \"processing reblog items\";\n\n\t\t\treblog_tree.find(\".reblog-list-item\").each(function(index) {\n\t\t\t\tvar reblog_data = {\n\t\t\t\t\treblog_content: $(this).find('.reblog-content').html() ? $(this).find('.reblog-content').html() : '',\n\t\t\t\t\treblog_author: $(this).find('.reblog-tumblelog-name').text() ? $(this).find('.reblog-tumblelog-name').text().trim() : '',\n\t\t\t\t\treblog_url: $(this).find('.reblog-tumblelog-name').attr('href')\n\t\t\t\t\t\t? $(this).find('.reblog-tumblelog-name').attr('href').trim()\n\t\t\t\t\t\t: 'http://' + $(this).find('.reblog-tumblelog-name').text().trim() + '.tumblr.com/post/1/undefined'\n\t\t\t\t};\n\t\t\t\tall_quotes.push(reblog_data);\n\t\t\t});\n\n\t\t\tall_quotes.forEach(function(data, index, all) {\n\t\t\t\tvar reblog_content = data.reblog_content.replace(\"tmblr-truncated read_more_container\", \"\");\n\t\t\t\tall_quotes_text = \"<p><a class='tumblr_blog' href='\" + data.reblog_url + \"'>\" + data.reblog_author + \"</a>:</p><blockquote>\" + all_quotes_text + reblog_content + \"</blockquote>\";\n\t\t\t});\n\t\t}\n\n\t\ttry {\n\t\t\told_content = XKit.interface.post_window.get_content_html();\n\t\t} catch (e) {\n\t\t\tXKit.window.show('Invalid editor type', 'ERROR: Editable Reblogs cannot currently get content from your default editor type. '+\n\t\t\t\t'To continue using editable reblogs, click <a target=\"_blank\" href=\"https://www.tumblr.com/settings/dashboard\">here</a> '+\n\t\t\t\t'to edit your dashboard settings to use the rich text editor or HTML editor',\n\t\t\t\t'error', \"<div id=\\\"xkit-close-message\\\" class=\\\"xkit-button\\\">OK</div>\");\n\t\t\tvar error = new Error(\"Editor Type\");\n\t\t\terror.hide_popup = true;\n\t\t\tthrow error;\n\t\t}\n\n\t\tthis.state = \"post processing\";\n\t\t// add 'tumblr_blog' class to all tumblr.com links,\n\t\t// assuming that they're part of a reblog-structure that's not being parsed properly\n\t\tvar nodes = $(all_quotes_text + old_content);\n\t\tnodes.find('a[href*=\"tumblr.com\"]').addClass('tumblr_blog');\n\t\tvar nodes_text = $('<div>').append($(nodes).clone()).html();\n\n\t\tvar undefined_urls = nodes_text.match(new RegExp(\"<a .*post/1/undefined\", \"g\")) || [];\n\t\tif (undefined_urls.length > 1) {\n\t\t\tvar error = new Error(\"Too many bad urls\");\n\t\t\terror.hide_url = true;\n\t\t\tthrow error;\n\t\t}\n\n\t\tthis.state = \"mutation\";\n\n\t\tvar title = reblog_tree.find('.reblog-title');\n\t\t$('.post-form--header').append(title);\n\t\tXKit.interface.post_window.set_content_html(nodes_text);\n\n\t\t$(\".btn-remove-trail .icon\").click();\n\t\t$(\".control-reblog-trail\").hide();\n\t},\n\n\treblog_tree_exists: function() {\n\t\t//if we don't have a reblog tree to edit, gtfo\n\t\t//this also applies to new posts\n\t\t//which saves us from worrying about things like photo replies\n\t\treturn $(\".post-form .reblog-list\").length !== 0;\n\t},\n\n\tinitialize_selected_post_type: function() {\n\t\tvar where = XKit.interface.where();\n\t\tif (where.dashboard) {\n\t\t\tthis.selected_post_type = \"PUBLISH\";\n\t\t} else if (where.drafts) {\n\t\t\tthis.selected_post_type = \"DRAFT\";\n\t\t} else if (where.queue) {\n\t\t\tthis.selected_post_type = \"QUEUE\";\n\t\t}\n\t},\n\n\trecord_post_settings: function(e) {\n\t\tvar post_dropdown_exists = $(e.target).parents(\".popover--save-post-dropdown\").length > 0;\n\t\tif (post_dropdown_exists) {\n\t\t\tvar clicked_li = e.target.tagName !== \"LI\" ? e.target.parentNode : e.target;\n\t\t\tfor (var i = 0; i < clicked_li.attributes.length; i++) {\n\t\t\t\t// looking for attribute like \"data-js-publish\" and \"data-js-draft\"\n\t\t\t\tvar attribute = clicked_li.attributes[i].name;\n\t\t\t\tif (attribute.startsWith(\"data-js-\") && !attribute.endsWith(\"preview\")) {\n\t\t\t\t\tvar type = attribute.substring(8).toUpperCase();\n\t\t\t\t\tthis.selected_post_type = type;\n\n\t\t\t\t\tif (type === \"SCHEDULE\") {\n\t\t\t\t\t\t$(\"[data-js-scheduletext]\").off(\"blur\");\n\t\t\t\t\t\t$(\"[data-js-scheduletext]\").on(\"blur\", this.update_scheduled_date.bind(this));\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tupdate_scheduled_date: function(e) {\n\t\tthis.scheduled_date = e.target.value;\n\t},\n\n\tmake_post: function(e) {\n\t\tif (!this.reblog_tree_exists() || this.state != \"success\") {\n\t\t\treturn;\n\t\t}\n\n\t\tvar post_types = this.post_types;\n\t\tswitch (post_types[this.selected_post_type]) {\n\t\t\tcase post_types.PUBLISH:\n\t\t\t\tthis.send_post_request(e);\n\t\t\t\tbreak;\n\t\t\tcase post_types.QUEUE:\n\t\t\t\tthis.send_queue_request(e);\n\t\t\t\tbreak;\n\t\t\tcase post_types.DRAFT:\n\t\t\t\tthis.send_draft_request(e);\n\t\t\t\tbreak;\n\t\t\tcase post_types.PRIVATE:\n\t\t\t\tthis.send_private_request(e);\n\t\t\t\tbreak;\n\t\t\tcase post_types.SCHEDULE:\n\t\t\t\tthis.send_schedule_request(e);\n\t\t\t\tbreak;\n\t\t}\n\t},\n\n\tsend_post_request: function(e) {\n\t\te.preventDefault();\n\t\tvar request = this.build_svc_request();\n\t\trequest[\"post[state]\"] = \"0\";\n\t\tthis.send_request(request);\n\t},\n\n\tsend_queue_request: function(e) {\n\t\te.preventDefault();\n\t\tvar request = this.build_svc_request();\n\t\trequest[\"post[state]\"] = \"2\";\n\t\tthis.send_request(request);\n\t},\n\n\tsend_draft_request: function(e) {\n\t\te.preventDefault();\n\t\tvar request = this.build_svc_request();\n\t\trequest[\"post[state]\"] = \"1\";\n\t\tthis.send_request(request);\n\t},\n\n\tsend_private_request: function(e) {\n\t\te.preventDefault();\n\t\tvar request = this.build_svc_request();\n\t\trequest[\"post[state]\"] = \"private\";\n\t\tthis.send_request(request);\n\t},\n\n\tsend_schedule_request: function(e) {\n\t\te.preventDefault();\n\t\tvar request = this.build_svc_request();\n\t\trequest[\"post[state]\"] = \"on.2\";\n\t\trequest[\"post[publish_on]\"] = this.scheduled_date;\n\t\tthis.send_request(request);\n\t},\n\n\tbuild_svc_request: function() {\n\t\tvar post_type = XKit.interface.post_window.post_type();\n\t\tvar request = this.build_common_svc_request();\n\t\tif (post_type.text) {\n\t\t\trequest[\"post[type]\"] = \"regular\";\n\t\t\t//@TODO make title editable\n\t\t\trequest[\"post[one]\"] = $('.post-form--header .reblog-title').text();\n\t\t}\n\t\tif (post_type.photo) {\n\t\t\trequest[\"post[type]\"] = \"photo\";\n\t\t}\n\t\tif (post_type.video) {\n\t\t\trequest[\"post[type]\"] = \"video\";\n\t\t}\n\t\tif (post_type.note) {\n\t\t\trequest[\"post[type]\"] = \"note\";\n\t\t\trequest[\"post[three]\"] = request[\"post[two]\"];\n\t\t\trequest[\"post[two]\"] = \"\";\n\t\t}\n\t\tif (post_type.audio) {\n\t\t\trequest[\"post[type]\"] = \"audio\";\n\t\t}\n\t\tif (post_type.link) {\n\t\t\trequest[\"post[type]\"] = \"link\";\n\t\t\trequest[\"post[three]\"] = request[\"post[two]\"];\n\t\t\trequest[\"post[two]\"] = \"\";\n\t\t}\n\t\treturn request;\n\t},\n\n\tbuild_common_svc_request: function() {\n\t\tvar request = {};\n\t\tvar location_path = window.location.pathname;\n\t\tvar location_items = location_path.split(\"/\");\n\t\tlocation_items.shift();\n\n\t\trequest.form_key = XKit.interface.form_key();\n\t\trequest.channel_id = $('.post-form--header .tumblelog-select .caption').text();\n\t\trequest.detached = true; //?\n\t\trequest.reblog = location_items[0] === \"reblog\";\n\n\t\tif (location_items[0] === \"reblog\") {\n\t\t\trequest.reblog_id = parseInt(location_items[1]);\n\t\t}\n\t\tif (location_items[0] === \"edit\") {\n\t\t\trequest.post_id = parseInt(location_items[1]);\n\t\t}\n\n\t\trequest.reblog_key = location_items[2];\n\t\trequest.errors = false;\n\t\trequest.silent = false;\n\t\trequest.context_id = \"\";\n\t\tif (location_items[0] === \"reblog\") {\n\t\t\trequest.reblog_post_id = location_items[1];\n\t\t}\n\t\tif (location_items[0] === \"edit\") {\n\t\t\trequest.edit_post_id = location_items[1];\n\t\t}\n\n\t\trequest.remove_reblog_tree = true;\n\t\trequest[\"is_rich_text[one]\"] = \"0\";\n\t\trequest[\"is_rich_text[two]\"] = \"1\";\n\t\trequest[\"is_rich_text[three]\"] = \"0\";\n\t\trequest[\"post[slug]\"] = this.post_slug_metadata;\n\t\trequest[\"post[draft_status]\"] = \"\";\n\t\trequest[\"post[date]\"] = this.post_date_metadata;\n\n\t\trequest[\"post[tags]\"] = $.map($('.post-form--footer .tag-label'), function(element, index) {\n\t\t\treturn $(element).text();\n\t\t}).join(\",\");\n\n\t\trequest[\"post[two]\"] = this.parse_html(XKit.interface.post_window.get_content_html());\n\n\t\tif ($('.post-forms--social-buttons .social-button.twitter').hasClass('checked')) {\n\t\t\trequest.send_to_twitter = \"on\";\n\t\t}\n\t\tif ($('.post-forms--social-buttons .social-button.facebook').hasClass('checked')) {\n\t\t\trequest.send_to_fbog = \"on\";\n\t\t}\n\t\t//@TODO maybe we can do this in the future\n\t\trequest.custom_tweet = false;\n\n\t\treturn request;\n\t},\n\n\tparse_html: function(data) {\n\n\t\tvar text = XKit.interface.post_window.get_content_html();\n\n\t\tvar nodes = $('<div>').append($(text));\n\t\tnodes.find('.tmblr-truncated').replaceWith('[[MORE]]');\n\n\n\t\t// tumblr_blog must be wrapped in single quotes,\n\t\t// not double, or the dash will nom the shit out of your post\n\t\t//********ALL DOM MANIPULATION ABOVE THIS LINE*********\n\t\ttext = nodes.html();\n\t\ttext = text.replace(/\"tumblr_blog\"/g, \"'tumblr_blog'\");\n\t\t// also remove empty HTML if the user hasn't added anything\n\t\tif (text.indexOf(\"<p><br></p>\", text.length - 11) !== -1) {\n\t\t\ttext = text.substring(0, text.length - 11);\n\t\t}\n\t\treturn text;\n\t},\n\n\tsend_request: function(request) {\n\t\tXKit.interface.kitty.get(function(kitty_data) {\n\n\t\t\tGM_xmlhttpRequest({\n\t\t\t\tmethod: \"POST\",\n\t\t\t\turl: \"http://www.tumblr.com/svc/post/update\",\n\t\t\t\tdata: JSON.stringify(request),\n\t\t\t\tjson: true,\n\t\t\t\theaders: {\n\t\t\t\t\t\"X-tumblr-puppies\": kitty_data.kitten,\n\t\t\t\t\t\"X-tumblr-form-key\": XKit.interface.form_key(),\n\t\t\t\t},\n\n\t\t\t\tonerror: function(response) {\n\t\t\t\t\tXKit.interface.kitty.set(\"\");\n\n\t\t\t\t\tvar github_url = XKit.tools.github_issue(\"Editable Reblogs posting error\",\n\t\t\t\t\t\t{ \"ER Version\": XKit.installed.get(\"editable_reblogs\").version,\n\t\t\t\t\t\t user: request.channel_id, body: request[\"post[two]\"], response: JSON.stringify(response)},\n\t\t\t\t\te);\n\n\t\t\t\t\tXKit.window.show(\"Error\",\n\t\t\t\t\t\t\"Error: XER-SR.<br><br>There was an error reblogging your post. Please try again shortly. \"+\n\t\t\t\t\t\t'<br><br>'+\n\t\t\t\t\t\t'<a target=\"_blank\" href=\"'+github_url+'\">You can report this issue on Github by clicking here</a>',\n\t\t\t\t\t\t\"error\",\n\t\t\t\t\t\t'<div class=\"xkit-button default\" id=\"xkit-close-message\">OK</div>');\n\n\t\t\t\t\tconsole.error(\"editable_reblogs.send_request:\\n\", response);\n\t\t\t\t},\n\n\t\t\t\tonload: function(response) {\n\t\t\t\t\t// We are done!\n\t\t\t\t\tXKit.interface.kitty.set(response.getResponseHeader(\"X-tumblr-kittens\"));\n\t\t\t\t\tvar redirect_url = XKit.tools.getParameterByName(\"redirect_to\");\n\t\t\t\t\tXKit.tools.add_function(function() {\n\t\t\t\t\t\tTumblr.Events.trigger(\"postForms:saved\");\n\t\t\t\t\t\tvar redirect_url = add_tag;\n\t\t\t\t\t\tif (redirect_url !== \"\") {\n\t\t\t\t\t\t\tsetTimeout(function(){\n\t\t\t\t\t\t\t\twindow.location.replace(redirect_url);\n\t\t\t\t\t\t\t}, 500);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, true, redirect_url);\n\t\t\t\t}\n\t\t\t});\n\n\t\t});\n\t},\n\n\tdestroy: function() {\n\t\tthis.running = false;\n\t\tXKit.tools.remove_css(\"editable_reblogs_remove_content_tree\");\n\t\t$(\"body\").off(\"click\", \".create_post_button\", XKit.extensions.editable_reblogs.send_post_request);\n\t\t$(\"body\").off(\"click\", XKit.extensions.editable_reblogs.record_post_settings);\n\t\tXKit.interface.post_window_listener.remove(\"editable_reblogs\");\n\t}\n});\n","file":"found","server":"up","errors":false,"icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAA4VBMVEUAAAAAAQEBAgICBAQCBQYDBggEBwkHDRAHDhIIEBQIEBUJEhYKFhALFRoLFRsMGRUNGSAPIRgQHycYLzsYNScbNkMcNkQcN0UdOEYdOEceOkgfPUwfPU0gPk0gPk4gP08hQFAiQlMjTTgjTTkkTjktV20tWG4yYXoyYns4bIg7co9Bfp9Bj2lEhKZFhqdFh6lFh6pHiq1JjrJJj7NMlLpNlbtNlrtNlrxNl7pNl7tNmLpOmLlQpKpQpalRpqZRpqdRp6VSqaNSsoNTr5tTsJpTsZhTsZlUspdUsphWu4lWvIqrAtY3AAABFklEQVR42qXQa1OCQBiG4cdKOtn5bEmaZklaZi5v27kgi/3/PygY9l1g02Gm7m/wXMPsAippCpBlYCJLgGIxE6hPWQTfyooFA/W7txIQ+DZ4pCzeC4DyIJRkg/c80Ltodg14sf/ka7yfotLV4Inonmi0Pw9ua0DjPaBynoJ4/yI6gGn3Q7R6iWhoICeKqIqhuUbkLjmxaIgU+KGKAaD3BxV1Vr2Vhd5YpGfwA5UEKF3UrnnrQIuv+awYmL0f78n3p34hOqv1N3jXZwjyZ3AXvTXAFdcZIBlm4AZzy8l+u8kgFQZcAMlO22CQCgOOATQFPxpA5s3OyeWQaAbg/giqGOT2Kzg2qKNY3QajQwdZztEdg5L+D34AmZvHFbsM2NwAAAAASUVORK5CYII=\n","title":"Editable Reblogs","description":"Restores ability to edit previous reblogs of a post","developer":"new-xkit","version":"3.1.0","frame":"false","beta":"false","slow":"false"}